package de.ww.openweather.controllers;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import de.ww.openweather.utils.Constants;
import de.ww.openweather.utils.OpenWeatherMapUtil;
import de.ww.openweather.utils.OpenweatherDateUtil;
import de.ww.openweather.utils.WetterBeschreibung;
import de.ww.openweather.utils.WetterDTO;
import de.ww.openweather.utils.WettervorhersageDTO;
import de.ww.openweather.utils.WettervorhersageEintragDTO;
import de.ww.openweather.utils.WettervorhersageTileDTO;
import de.ww.openweather.utils.persistence.Ort;
import de.ww.openweather.utils.persistence.Wetteraufzeichnung;
import de.ww.openweather.utils.repositories.OrtRepository;
import de.ww.openweather.utils.repositories.WetteraufzeichnungRepository;

@Controller
@RequestMapping("wetter")
public class WetterController {

	// Vorhersage
	//http://api.openweathermap.org/data/2.5/forecast?zip=13187,de&APPID=a69fc6770115d5a82cd0d37e359ad4bf&lang=de&units=metric
	//http://api.openweathermap.org/data/2.5/forecast?zip=13187,de&APPID=a69fc6770115d5a82cd0d37e359ad4bf&lang=de&units=metric&mode=json
	
	@Autowired
	private WetteraufzeichnungRepository wetteraufzeichnungRepo;
	
	@Autowired
	private OrtRepository ortRepo;	
	
	private Logger log = LogManager.getLogger(this.getClass().getName());
	
	/**
	 * Gibt das Wetter in Berlin Pankow als HTML-Response zur&uuml;ck
	 * http://127.0.0.1:9999/wetter/html/berlin_pankow
	 * @return das Wetter in Berlin Pankow als HTML-Response
	 */	
	@RequestMapping(value="/html/berlin_pankow", method = RequestMethod.GET, produces = "text/html")
	public @ResponseBody String getWetterBerlin() {
		WetterDTO dtoPankow = OpenWeatherMapUtil.getWetter(Constants.url_Berlin_Pankow);
		storeWetteraufzeichnung(dtoPankow);
		return dtoPankow.getHtml();
	}
	
	/**
	 * Gibt das Wetter in Palma als HTML-Response zur&uuml;ck
	 * http://127.0.0.1:9999/wetter/html/palma
	 * @return das Wetter in Palma als HTML-Response
	 */
	@RequestMapping(value="/html/palma", method = RequestMethod.GET, produces = "text/html")
	public @ResponseBody String getWetterPalma() {
		WetterDTO dtoPalma = OpenWeatherMapUtil.getWetter(Constants.url_Palma_de_Mallorca);
		storeWetteraufzeichnung(dtoPalma);
		return dtoPalma.getHtml();
	}
	
	
	/**
	 * Gibt das Wetter in Palma als JSON-Response zur&uuml;ck
	 * http://127.0.0.1:9999/wetter/json/palma
	 * @return das Wetter in Palma als HTML-Response
	 */
	@RequestMapping(value="/json/palma", method = RequestMethod.GET, produces = "application/json")
	public @ResponseBody WetterDTO getJsonWetterPalma() {
		WetterDTO dtoPalma = OpenWeatherMapUtil.getWetter(Constants.url_Palma_de_Mallorca);
		return dtoPalma;
	}	
	
	/**
	 * Gubt die Liste mit Wetteraufzeichnung zur&uuml;ck
	 */
	@RequestMapping(value="/html/wetterdaten", method = RequestMethod.GET, produces = "text/html")
	public @ResponseBody String getWetterDaten() {
		List<Wetteraufzeichnung> wetteraufzeichnungen = (List<Wetteraufzeichnung>) wetteraufzeichnungRepo.findAll();
		StringBuilder html = new StringBuilder("<table>\n");
		for (Wetteraufzeichnung wa : wetteraufzeichnungen) {
			String s = "Das Wetter in " + wa.getOrt() 
			+ " um " + wa.getZeitString()
			+ ": Temperatur " + wa.getTemperatur() + "°C"
			+ ", " + wa.getWetterbeschreibung();
			html.append("<tr><td>" + s + "</td><td><img src=\""+ wa.getIconUrl() + "\"/></td></tr>\n");		
			log.debug(s);
		}
		html.append("</table>");
		return html.toString();
	}	

	/**
	 * Gubt die Liste mit Wetteraufzeichnung von Palma zur&uuml;ck
	 * @return Liste mit Wetteraufzeichnung von Palma
	 */	
	@RequestMapping(value="/html/wetterdaten/palma", method = RequestMethod.GET, produces = "text/html")
	public @ResponseBody String getWetterDatenPalma() {
//		List<Wetteraufzeichnung> wetteraufzeichnungen = wetteraufzeichnungRepo.findByOrtOrderByIdDesc("Palma de Mallorca");
		List<Wetteraufzeichnung> wetteraufzeichnungen = wetteraufzeichnungRepo.findByOrtLikeOrderByIdDesc("Palma%");
		StringBuilder html = new StringBuilder("<table>\n");
		for (Wetteraufzeichnung wa : wetteraufzeichnungen) {
			String s = "Das Wetter in " + wa.getOrt() 
			+ " um " + wa.getZeitString()
			+ ": Temperatur " + wa.getTemperatur() + "°C"
			+ ", " + wa.getWetterbeschreibung();
			html.append("<tr><td>" + s + "</td><td><img src=\""+ wa.getIconUrl() + "\"/></td></tr>\n");		
			log.debug(s);
		}
		html.append("</table>");
		return html.toString();
	}		
	
	/**
	 * Speichert einen Wetterdatensatz	
	 * @param wetterDTO DTO eines Wetterdatensatzes
	 */
	private void storeWetteraufzeichnung(WetterDTO wetterDTO) {
		Wetteraufzeichnung wetter = new Wetteraufzeichnung();
		wetter.setOrt(wetterDTO.getOrt());
		wetter.setLand(wetterDTO.getLand());
		wetter.setGeoBreite(wetterDTO.getGeoBreite());
		wetter.setGeoLaenge(wetterDTO.getGeoLaenge());
		wetter.setTemperatur(wetterDTO.getTemperatur());
		wetter.setTemperatur_min(wetterDTO.getTemperatur_min());
		wetter.setTemperatur_max(wetterDTO.getTemperatur_max());
		wetter.setLuftDruck(wetterDTO.getLuftDruck());
		wetter.setLuftFeuchtigkeit(wetterDTO.getLuftFeuchtigkeit());
		wetter.setWindGeschwindigkeit(wetterDTO.getWindGeschwindigkeit());
		wetter.setWindRichtung(wetterDTO.getWindRichtung());
		wetter.setWolken(wetterDTO.getWolken());
		wetter.setZeitStempel(wetterDTO.getZeitStempel());
		wetter.setZeitString(wetterDTO.getZeitString());
		
		if (wetterDTO.getWetterbeschreibungen().length > 0) {
			for (int y = 0; y < wetterDTO.getWetterbeschreibungen().length; y++) {
				WetterBeschreibung wetterBeschreibung = wetterDTO.getWetterbeschreibungen()[y];
				wetter.setWetterbeschreibung(wetterBeschreibung.getDescription());
				wetter.setIconUrl(wetterBeschreibung.getIconUrl());
			}
		} else {
			log.info("Keine weiteren Wetterinformationen");
		}		
		
		wetteraufzeichnungRepo.save(wetter);	
		log.info("Wetteraufzeichnung fuer " + wetterDTO.getOrt() + " wurde gespeichert");
	}
	
	
	// <<<<<<<<<<<<<<<<<<<<<< REST - CALLS >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
	
	
	
	/**
	 * Gibt eine Liste mit Wetteraufzeichnungsdaten zur&uuml;ck
	 * http://127.0.0.1:9999/wetter/all
	 * @return List mit Wetterdatens&auml;tzen
	 */
	@RequestMapping(value="/all", method = RequestMethod.GET, produces = "application/json")
	public @ResponseBody List<Wetteraufzeichnung> getWetterdatenAll() {
		log.debug("getWetterdatenAll (URL: /wetter/all) ...");
		List<Wetteraufzeichnung> wetteraufzeichnungen = (List<Wetteraufzeichnung>) wetteraufzeichnungRepo.findAll();
		return wetteraufzeichnungen;
	}
	
	/**
	 * Gibt einen Wetteraufzeichnunsdatensatz anhand seines PK zur&uuml;ck
	 * http://127.0.0.1:9999/wetter/byId/4
	 * @param id PK des Wettersdatensatzes
	 * @return Wetterdatensatz mit PK=4
	 */
	@RequestMapping(value="/byId/{id}", method = RequestMethod.GET, produces = "application/json")
	public @ResponseBody Wetteraufzeichnung getWetterdatenById(@PathVariable Long id) {
		Wetteraufzeichnung wetteraufzeichnung = wetteraufzeichnungRepo.findOne(id);
		return wetteraufzeichnung;
	}	
	
	/**
	 * Gibt das Wetter f&uuml;r den Ort <i>ort</i> als JSON-Response zur&uuml;ck
	 * http://127.0.0.1:9999/restservices/wetterByOrt/Berlin
	 * http://127.0.0.1:9999/#!/wetterByOrt/Palma
	 * @param ort Ort
	 * @return das Wetter in Berlin Pankow als HTML-Response
	 */	
	@RequestMapping(value="/byOrt/{ort}", method = RequestMethod.GET, produces = "application/json")
	public @ResponseBody WetterDTO getWetterByOrt(@PathVariable String ort) {
		log.debug("wetterByOrt: " + ort);
		WetterDTO dto = null;
		if (ort.toLowerCase().indexOf("berlin") > -1) {
			dto = OpenWeatherMapUtil.getWetter(Constants.url_Berlin_Pankow);
		} else if (ort.toLowerCase().indexOf("palma") > -1) {
			dto = OpenWeatherMapUtil.getWetter(Constants.url_Palma_de_Mallorca);
		} else {
			dto = OpenWeatherMapUtil.getWetter(Constants.url_Berlin_Pankow);
		}
		return dto;
	}		
	
	/**
	 * Gibt das Wetter f&uuml;r den Ort <i>id</i> als JSON-Response zur&uuml;ck
	 * http://127.0.0.1:9999/wetter/wetterByOrtId/1
	 * http://127.0.0.1:9999/wetter/wetterByOrtId/9
	 * @param ort Ort
	 * @return das Wetter in Berlin Pankow als HTML-Response
	 */	
	@RequestMapping(value="/wetterByOrtId/{id}", method = RequestMethod.GET, produces = "application/json")
	public @ResponseBody WetterDTO getWetterByOrtId(@PathVariable String id) {
		log.debug("wetterByOrtId: " + id);
		WetterDTO dto = null;		
		
		try {
			Long pk = Long.parseLong(id);
			Ort ort = ortRepo.findOne(pk);
			if (ort != null && ort.getUrlOpenweatherOrtAktuell() != null) {
				log.debug("Wetterdaten fuer " + ort.getOrt() + " abfragen...");
				dto = OpenWeatherMapUtil.getWetter(ort.getUrlOpenweatherOrtAktuell());
				log.debug("Wetter: " + dto.toString());
			} else {
				log.info("Der das Wetter fuer den Ort mit dem PK " + id + " konnte nicht ermittelt werden - Standard Berlin Pankow.");
				dto = OpenWeatherMapUtil.getWetter(Constants.url_Berlin_Pankow);
			}
		} catch (Exception e) {
			log.info("Der das Wetter fuer den Ort mit dem PK " + id + " konnte nicht ermittelt werden - Standard Berlin Pankow.");
			dto = OpenWeatherMapUtil.getWetter(Constants.url_Berlin_Pankow);
		}
		
		return dto;
	}	
	
	
	/**
	 * Gibt die Wettervorhersage f&uuml;r den Ort <i>ort</i> JSON-Response zur&uuml;ck
	 * http://127.0.0.1:9999/wetter/vorhersage/byOrt/Berlin
	 * http://127.0.0.1:9999/wetter/vorhersage/byOrt/Palma
	 * @return das Wetter in Berlin Pankow als HTML-Response
	 */	
	@RequestMapping(value="/vorhersage/byOrt/{ort}", method = RequestMethod.GET, produces = "application/json")
	public @ResponseBody WettervorhersageDTO getWettervorhersageByOrt(@PathVariable String ort) {
		log.debug("wetter/vorhersage/byOrt: " + ort);
		WettervorhersageDTO dto = null;
		if (ort.toLowerCase().indexOf("berlin") > -1) {
			dto = OpenWeatherMapUtil.getWettervorhersage(Constants.url_Berlin_Pankow_vorhersage);
		} else if (ort.toLowerCase().indexOf("palma") > -1) {
			dto = OpenWeatherMapUtil.getWettervorhersage(Constants.url_Palma_de_Mallorca_vorhersage);
		} else {
			dto = OpenWeatherMapUtil.getWettervorhersage(Constants.url_Berlin_Pankow_vorhersage);
		}
		log.debug(dto.toString());

		List<WettervorhersageEintragDTO> vorhersagen = dto.getWeather();
		HashMap<String, WettervorhersageTileDTO> vorhersageMap = new HashMap<String, WettervorhersageTileDTO>();
		String tmpDatum = null;
		String tmpDatumOld = "";
		ArrayList<Double> tempList = null;
		WettervorhersageTileDTO tileDTO = null;
		for (WettervorhersageEintragDTO vorhersage : vorhersagen) {
			
			tmpDatum = vorhersage.getDtString().substring(0, 10);

			if (!tmpDatum.equals(tmpDatumOld)) {
				
				if (tempList != null && tempList.size() > 0) {
					log.debug("+++++Zusammenfassung fuer den "  
							+ tileDTO.getDatumString() + ": " 
							+ ", DTO: "  + tileDTO.toString());	
					vorhersageMap.put(tileDTO.getDatumString(), tileDTO);
				}

				log.info("\n\n>----- Neues Datum: " + tmpDatum);
				tempList = new ArrayList<Double>();
				tileDTO = new WettervorhersageTileDTO();
				tileDTO.setDatumString(tmpDatum);
				tileDTO.setBeschreibung(vorhersage.getWeather()[0].getDescription());
				tileDTO.setIconUrl(vorhersage.getWeather()[0].getIconUrl());
				tempList.add(vorhersage.getTemp());
			}

			tempList.add(vorhersage.getTemp());
			tempList.sort(new DoubleComparator());

			tileDTO.setTempMin(tempList.get(0));
			tileDTO.setTempMax(tempList.get(tempList.size()-1));
			tileDTO.setBeschreibung(vorhersage.getWeather()[0].getDescription());
			tileDTO.setIconUrl(vorhersage.getWeather()[0].getIconUrl());
			
			log.debug("----- Datum: " + vorhersage.getDtString() + ", DTO: " 
					+ tileDTO.toString());			
			
			
			tmpDatumOld = tmpDatum;
		}		
		
		// Zusammenfassung letztes Datum
		if (tempList != null && tempList.size() > 0) {
			log.debug("+++++ Zusammenfassung fuer den "  
					+ tileDTO.getDatumString() + ": " 
					+ ", DTO: "  + tileDTO.toString());	
			vorhersageMap.put(tileDTO.getDatumString(), tileDTO);
		}		
		
		List<String> datumsStringRange = OpenweatherDateUtil.getDatumsStringRange();
		for (String datumsString : datumsStringRange) {
			log.info("\n-----------------------------------------------");
			WettervorhersageTileDTO tmpTileDTO = vorhersageMap.get(datumsString);
			log.info("--- " + tmpTileDTO.getDatumString() 
				+ ": Temp(min): " + tmpTileDTO.getTempMin()
				+ ": Temp(max): " + tmpTileDTO.getTempMax()
				+ ": Wetter: " + tmpTileDTO.getBeschreibung()
				+ ": Icon: " + tmpTileDTO.getIconUrl()
				);
			log.info("\n-----------------------------------------------");
		}
		
		
		return dto;
	}	
	
	class DoubleComparator implements Comparator<Double>{

		@Override
		public int compare(Double o1, Double o2) {
			if (o1.doubleValue() < o2.doubleValue()) {
				return -1;
			} else if (o1.doubleValue() > o2.doubleValue()) {
				return 1;
			} else {
				return 0;
			}
		}
		
	}
	
}
